name: WorkflowCall - Changes

on:
  workflow_call:
    inputs:
      use_previous_release:
        description: "Whether to compare against previous release tag (for production) or use default git comparison (for development)"
        required: false
        type: boolean
        default: false
    outputs:
      account:
        value: ${{ jobs.changes.outputs.account }}
        description: "account changes"
      exam:
        value: ${{ jobs.changes.outputs.exam }}
        description: "exam changes"

jobs:
  changes:
    outputs:
      account: ${{ steps.filter.outputs.account }}
      exam: ${{ steps.filter.outputs.exam }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch all history when comparing against previous release
          fetch-depth: ${{ inputs.use_previous_release && 0 || 1 }}

      - name: Get previous release tag
        if: ${{ inputs.use_previous_release }}
        id: previous-tag
        run: |
          # Get the current tag from the ref
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "current-tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "current-tag=$CURRENT_TAG"

          echo $(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$')

          # Get all release tags sorted by version, excluding the current one
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^${CURRENT_TAG}$" | head -1)

          # If no previous tag found, compare against initial commit
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
            echo "No previous release tag found, comparing against initial commit: $PREVIOUS_TAG"
          else
            echo "Comparing current tag $CURRENT_TAG with previous tag: $PREVIOUS_TAG"
          fi

          echo "previous-tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            account:
              - 'apps/account/**'
            exam:
              - 'apps/exam/**'
