name: WorkflowCall - Changes

on:
  workflow_call:
    inputs:
      use_previous_release:
        description: "Whether to compare against previous release tag (for production) or use default git comparison (for development)"
        required: false
        type: boolean
        default: false
    outputs:
      account:
        value: ${{ jobs.changes.outputs.account }}
        description: "account changes"
      exam:
        value: ${{ jobs.changes.outputs.exam }}
        description: "exam changes"

jobs:
  changes:
    outputs:
      account: ${{ steps.filter.outputs.account }}
      exam: ${{ steps.filter.outputs.exam }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug input
        run: |
          echo "use_previous_release input: '${{ inputs.use_previous_release }}'"
          echo "Type check: ${{ inputs.use_previous_release == true }}"
          echo "String check: ${{ inputs.use_previous_release == 'true' }}"
          echo "Calculated fetch-depth: ${{ inputs.use_previous_release == 'true' && 0 || 1 }}"
          echo "New calculation: ${{ inputs.use_previous_release && '0' || '1' }}"

      - uses: actions/checkout@v4
        with:
          # Fetch all history when comparing against previous release
          fetch-depth: ${{ inputs.use_previous_release && '0' || '1' }}

      - name: Get previous release tag
        if: ${{ inputs.use_previous_release }}
        id: previous-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the current tag from the ref
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "current-tag=$CURRENT_TAG" >> $GITHUB_OUTPUT

          # Get all release tags using gh, excluding the current one
          PREVIOUS_TAG=$(gh release list --json tagName --jq '.[].tagName' | grep -v "^${CURRENT_TAG}$" | head -1)

          echo "Comparing $CURRENT_TAG with previous tag: $PREVIOUS_TAG"
          echo "previous-tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ inputs.use_previous_release && steps.previous-tag.outputs.previous-tag || '' }}
          filters: |
            account:
              - 'apps/account/**'
            exam:
              - 'apps/exam/**'

      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          paths_filter: |
            frontend:
              paths:
                - 'frontend/**'
            backend:
              paths:
                - 'backend/**'
